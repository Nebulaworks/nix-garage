#!/usr/bin/env bash
# vim: ft=sh sw=2 et
# shellcheck shell=bash
set -efo pipefail

registry="docker.io"

# Assume that we will pass in attribute path, i.e. imgs.awsutils
# if not just build all imgs
attr=${1:-'imgs'}

for entry in $(nix-instantiate -A $attr); do
  derivation=$(nix show-derivation $entry)
  image_fullname=$(echo $derivation | jq -r '.[] | .env.imageName')
  org=$(echo $image_fullname | cut -d '/' -f 1)
  image_name=$(echo $image_fullname | cut -d '/' -f 2)
  calcout=$(echo $derivation | jq '.[] | .env.out')
  calcout=$(basename ${calcout} | cut -d '-' -f1)
  registry_endpoint="${registry}/${org}/${image_name}:${calcout}"

  # Check if this image is already in the registry and if so continue to next item in the list
  skopeo inspect docker://${registry_endpoint} && continue

  # I guess we need to build and push this to the registry if weve made it this far
  # We can use the drv here since we dont have the attribute path
  nix-build $entry
  skopeo --insecure-policy copy docker-archive:result docker://${registry_endpoint}
done

